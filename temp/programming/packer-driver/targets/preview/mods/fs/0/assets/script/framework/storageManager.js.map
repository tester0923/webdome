{"version":3,"sources":["file:///Users/amliya/Project/game/demo/test/assets/script/framework/storageManager.ts"],"names":["_decorator","sys","log","util","ccclass","property","StorageManager","start","jsonData","_path","_getConfigPath","console","content","isNative","valueObject","jsb","fileUtils","getValueMapFromFile","_keyConfig","localStorage","getItem","length","startsWith","substring","decrypt","JSON","parse","excepaiton","_saveTimer","setInterval","scheduleSave","setConfigDataWithoutSave","key","value","account","userId","error","setConfigData","_markSave","getConfigData","setGlobalData","save","getGlobalData","setUserId","getUserId","markModified","str","stringify","zipStr","encrypt","ls","setItem","valueObj","getWritablePath","writeToFile","platform","path","OS","WINDOWS","LINUX","_instance"],"mappings":"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","sourcesContent":["import { _decorator, sys, log } from \"cc\";\nimport { util } from './util';\n\nconst { ccclass, property } = _decorator;\n\n@ccclass(\"StorageManager\")\nexport class StorageManager {\n    private static _instance: StorageManager;\n\n    public static get instance () {\n        if (this._instance) {\n            return this._instance;\n        }\n\n        this._instance = new StorageManager();\n        this._instance.start();\n        return this._instance;\n    }\n\n    private _path: any = null;\n    private _keyConfig: string = 'archero';//游戏英文名称\n    private _markSave: boolean = false;\n    private _saveTimer: number = -1;\n\n    public jsonData: {[key: string]: any} = {};\n\n    start () {\n        this.jsonData = {\n            \"userId\": \"\",\n        };\n\n        this._path = this._getConfigPath();\n        console.log(this._path)\n\n        var content;\n        if (sys.isNative) {\n            var valueObject = jsb.fileUtils.getValueMapFromFile(this._path);\n            content = valueObject[this._keyConfig];\n        } else {\n            content = sys.localStorage.getItem(this._keyConfig);\n            console.log('content:',content)\n        }\n\n        // // 解密代码\n        // if (cc.game.config[\"encript\"]) {\n        //     var newContent = new Xxtea(\"upgradeHeroAbility\").xxteaDecrypt(content);\n        //     if (newContent && newContent.length > 0) {\n        //         content = newContent;\n        //     }\n        // }\n\n        if (content && content.length) {\n            if (content.startsWith('@')) {\n                content = content.substring(1);\n                content = util.decrypt(content);\n                console.log('decrypt',content)\n            }\n\n            try {\n                //初始化操作\n                var jsonData = JSON.parse(content);\n                this.jsonData = jsonData;\n            }catch (excepaiton) {\n\n            }\n\n        }\n\n        //启动无限定时器，每1秒保存一次数据，而不是无限保存数据\n        // this._saveTimer = setInterval(() =>{\n        //     this.scheduleSave();\n        // }, 500);\n\n        //每隔5秒保存一次数据，主要是为了保存最新在线时间，方便离线奖励时间判定\n        this._saveTimer = setInterval(() =>{\n            this.scheduleSave();\n        }, 5000);\n    }\n\n    /**\n     * 存储配置文件，不保存到本地\n     * @param {string}key  关键字\n     * @param {any}value  存储值\n     */\n    setConfigDataWithoutSave (key: string, value: any) {\n        let account: string= this.jsonData.userId;\n        if (this.jsonData[account]) {\n            this.jsonData[account][key] = value;\n        } else {\n            console.error(\"no account can not save\");\n        }\n    }\n\n  /**\n     * 存储配置文件，保存到本地\n     * @param {string}key  关键字\n     * @param {any}value  存储值\n     */\n    setConfigData (key: string, value: any) {\n        this.setConfigDataWithoutSave(key, value);\n        this._markSave = true; //标记为需要存储，避免一直在写入，而是每隔一段时间进行写入\n    }\n\n    /**\n     * 根据关键字获取数值\n     * @param {string} key 关键字\n     * @returns \n     */\n    getConfigData (key: string) {\n        let account: string = this.jsonData.userId;\n        if (this.jsonData[account]) {\n            var value = this.jsonData[account][key];\n            return value ? value : \"\";\n        } else {\n            log(\"no account can not load\");\n            return \"\";\n        }\n    }\n\n    /**\n     * 设置全局数据\n     * @param {string} key 关键字\n     * @param {any}value  存储值\n     * @returns \n     */\n    public setGlobalData (key:string, value: any) {\n        this.jsonData[key] = value;\n        this.save();\n    }\n\n    /**\n     * 获取全局数据\n     * @param {string} key 关键字\n     * @returns \n     */\n    public getGlobalData (key:string) {\n        console.log(this.jsonData)\n        return this.jsonData[key];\n    }\n\n    /**\n     * 设置用户唯一标示符\n     * @param {string} userId 用户唯一标示符\n     * @param {any}value  存储值\n     * @returns \n     */\n    public setUserId (userId:string) {\n        this.jsonData.userId = userId;\n        if (!this.jsonData[userId]) {\n            this.jsonData[userId] = {};\n        }\n\n        this.save();\n    }\n\n    /**\n     * 获取用户唯一标示符\n     * @returns {string}\n     */\n    public getUserId () {\n        return this.jsonData.userId;\n    }\n\n    /**\n     * 定时存储\n     * @returns \n     */\n    public scheduleSave () {\n        if (!this._markSave) {\n            return;\n        }\n\n        this.save();\n    }\n\n    /**\n     * 标记为已修改\n     */\n     public markModified () {\n        this._markSave = true;\n    }\n\n    /**\n     * 保存配置文件\n     * @returns \n     */\n    public save () {\n        console.log(\"写入文件\")\n        // 写入文件\n        var str = JSON.stringify(this.jsonData);\n\n        // // 加密代码\n        // if (cc.game.config[\"encript\"]) {\n        //     str = new Xxtea(\"upgradeHeroAbility\").xxteaEncrypt(str);\n        // }\n\n        let zipStr = '@' + util.encrypt(str);\n        // let zipStr = str;\n\n        this._markSave = false;\n        \n        if (!sys.isNative) {\n            console.log(2222)\n            var ls = sys.localStorage;\n            ls.setItem(this._keyConfig, zipStr);\n            console.log(this._keyConfig)\n            return;\n        }\n\n        var valueObj: any = {};\n        valueObj[this._keyConfig] = zipStr;\n        console.log(valueObj)\n        // jsb.fileUtils.writeToFile(valueObj, this._path);\n        console.log(jsb.fileUtils.getWritablePath())\n        jsb.fileUtils.writeToFile(valueObj);\n        \n    }\n\n    /**\n     * 获取配置文件路径\n     * @returns 获取配置文件路径\n     */\n    private _getConfigPath () {\n\n        let platform: any= sys.platform;\n\n        let path: string = \"\";\n\n        if (platform === sys.OS.WINDOWS) {\n            path = \"src/conf\";\n        } else if (platform === sys.OS.LINUX) {\n            path = \"./conf\";\n        } else {\n            if (sys.isNative) {\n                path = jsb.fileUtils.getWritablePath();\n                console.log('获取Native')\n                path = path + \"conf\";\n            } else {\n                path = \"src/conf\";\n            }\n        }\n\n        return path;\n    }\n}\n"]}